/*
 * ssd1306.c
 *
 * Created: 7/13/2024 12:51:20 AM
 *  Author: hop
 */ 
#include "ssd1306.h"

const char font[][6] = {
	// Only the character '0' (ASCII 48)
	[32 - 32] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // sp
	[33 - 32] = {0x00, 0x00, 0x00, 0x2f, 0x00, 0x00}, // !
	[34 - 32] = {0x00, 0x00, 0x07, 0x00, 0x07, 0x00}, // "
	[35 - 32] = {0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14}, // #
	[36 - 32] = {0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12}, // $
	[37 - 32] = {0x00, 0x62, 0x64, 0x08, 0x13, 0x23}, // %
	[38 - 32] = {0x00, 0x36, 0x49, 0x55, 0x22, 0x50}, // &
	[39 - 32] = {0x00, 0x00, 0x05, 0x03, 0x00, 0x00}, // '
	[40 - 32] = {0x00, 0x00, 0x1c, 0x22, 0x41, 0x00}, // (
	[41 - 32] = {0x00, 0x00, 0x41, 0x22, 0x1c, 0x00}, // )
	[42 - 32] = {0x00, 0x14, 0x08, 0x3E, 0x08, 0x14}, // *
	[43 - 32] = {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08}, // +
	[44 - 32] = {0x00, 0x00, 0x00, 0xA0, 0x60, 0x00}, // ,
	[45 - 32] = {0x00, 0x08, 0x08, 0x08, 0x08, 0x08}, // -
	[46 - 32] = {0x00, 0x00, 0x60, 0x60, 0x00, 0x00}, // .
	[47 - 32] = {0x00, 0x20, 0x10, 0x08, 0x04, 0x02}, // /
	[48 - 32] = {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E}, // '0'
	[49 - 32] = {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00},  // '1'
	[50 - 32] = {0x00, 0x42, 0x61, 0x51, 0x49, 0x46}, // 2
	[51 - 32] = {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31}, // 3
	[52 - 32] = {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
	[53 - 32] = {0x00, 0x27, 0x45, 0x45, 0x45, 0x39}, // 5
	[54 - 32] = {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30}, // 6
	[55 - 32] = {0x00, 0x01, 0x71, 0x09, 0x05, 0x03}, // 7
	[56 - 32] = {0x00, 0x36, 0x49, 0x49, 0x49, 0x36}, // 8
	[57 - 32] = {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E}, // 9
	[58 - 32] = {0x00, 0x00, 0x36, 0x36, 0x00, 0x00}, // :
	[59 - 32] = {0x00, 0x00, 0x56, 0x36, 0x00, 0x00}, // ;
	[60 - 32] = {0x00, 0x08, 0x14, 0x22, 0x41, 0x00}, // <
	[61 - 32] = {0x00, 0x14, 0x14, 0x14, 0x14, 0x14}, // =
	[62 - 32] = {0x00, 0x00, 0x41, 0x22, 0x14, 0x08}, // >
	[63 - 32] = {0x00, 0x02, 0x01, 0x51, 0x09, 0x06}, // ?
	[64 - 32] = {0x00, 0x32, 0x49, 0x59, 0x51, 0x3E}, // @
	[65 - 32] = {0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C}, // A
	[66 - 32] = {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36}, // B
	[67 - 32] = {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22}, // C
	[68 - 32] = {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C}, // D
	[69 - 32] = {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41}, // E
	[70 - 32] = {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01}, // F
	[71 - 32] = {0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A}, // G
	[72 - 32] = {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
	[73 - 32] = {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00}, // I
	[74 - 32] = {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01}, // J
	[75 - 32] = {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41}, // K
	[76 - 32] = {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40}, // L
	[77 - 32] = {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F}, // M
	[78 - 32] = {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F}, // N
	[79 - 32] = {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
	[80 - 32] = {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06}, // P
	[81 - 32] = {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E}, // Q
	[82 - 32] = {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46}, // R
	[83 - 32] = {0x00, 0x46, 0x49, 0x49, 0x49, 0x31}, // S
	[84 - 32] = {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01}, // T
	[85 - 32] = {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
	[86 - 32] = {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
	[87 - 32] = {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F}, // W
	[88 - 32] = {0x00, 0x63, 0x14, 0x08, 0x14, 0x63}, // X
	[89 - 32] = {0x00, 0x07, 0x08, 0x70, 0x08, 0x07}, // Y
	[90 - 32] = {0x00, 0x61, 0x51, 0x49, 0x45, 0x43}, // Z
	[91 - 32] = {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, // [
	[92 - 32] = {0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55}, // backslash
	[93 - 32] = {0x00, 0x00, 0x41, 0x41, 0x7F, 0x00}, // ]
	[94 - 32] = {0x00, 0x04, 0x02, 0x01, 0x02, 0x04}, // ^
	[95 - 32] = {0x00, 0x40, 0x40, 0x40, 0x40, 0x40}, // _
	[96 - 32] = {0x00, 0x00, 0x01, 0x02, 0x04, 0x00}, // '
	[97 - 32] = {0x00, 0x20, 0x54, 0x54, 0x54, 0x78}, // a
	[98 - 32] = {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38}, // b
	[99 - 32] = {0x00, 0x38, 0x44, 0x44, 0x44, 0x20}, // c
	[100 - 32] ={0x00, 0x38, 0x44, 0x44, 0x48, 0x7F}, // d
	[101 - 32] ={0x00, 0x38, 0x54, 0x54, 0x54, 0x18}, // e
	[102 - 32] ={0x00, 0x08, 0x7E, 0x09, 0x01, 0x02}, // f
	[103 - 32] ={0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C}, // g
	[104 - 32] ={0x00, 0x7F, 0x08, 0x04, 0x04, 0x78}, // h
	[105 - 32] ={0x00, 0x00, 0x44, 0x7D, 0x40, 0x00}, // i
	[106 - 32] ={0x00, 0x40, 0x80, 0x84, 0x7D, 0x00}, // j
	[107 - 32] ={0x00, 0x7F, 0x10, 0x28, 0x44, 0x00}, // k
	[108 - 32] ={0x00, 0x00, 0x41, 0x7F, 0x40, 0x00}, // l
	[109 - 32] ={0x00, 0x7C, 0x04, 0x18, 0x04, 0x78}, // m
	[110 - 32] ={0x00, 0x7C, 0x08, 0x04, 0x04, 0x78}, // n
	[111 - 32] ={0x00, 0x38, 0x44, 0x44, 0x44, 0x38}, // o
	[112 - 32] ={0x00, 0xFC, 0x24, 0x24, 0x24, 0x18}, // p
	[113 - 32] ={0x00, 0x18, 0x24, 0x24, 0x18, 0xFC}, // q
	[114 - 32] ={0x00, 0x7C, 0x08, 0x04, 0x04, 0x08}, // r
	[115 - 32] ={0x00, 0x48, 0x54, 0x54, 0x54, 0x20}, // s
	[116 - 32] ={0x00, 0x04, 0x3F, 0x44, 0x40, 0x20}, // t
	[117 - 32] ={0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C}, // u
	[118 - 32] ={0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C}, // v
	[119 - 32] ={0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C}, // w
	[120 - 32] ={0x00, 0x44, 0x28, 0x10, 0x28, 0x44}, // x
	[121 - 32] ={0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C}, // y
	[122 - 32] ={0x00, 0x44, 0x64, 0x54, 0x4C, 0x44}, // z
	[123- 32] = {0x00, 0x00, 0x08, 0x77, 0x41, 0x00}, // {
	[124 - 32] ={0x00, 0x00, 0x00, 0x63, 0x00, 0x00}, // �
	[125 - 32] ={0x00, 0x00, 0x41, 0x77, 0x08, 0x00}, // }
	[126 - 32] ={0x00, 0x08, 0x04, 0x08, 0x08, 0x04}, // ~
	[127 - 32] ={0x00, 0x3A, 0x40, 0x40, 0x20, 0x7A}, // �,
	[128 - 32] ={0x00, 0x3D, 0x40, 0x40, 0x40, 0x3D}, // �
	[129 - 32] ={0x00, 0x21, 0x54, 0x54, 0x54, 0x79}, // �
	[130 - 32] ={0x00, 0x7D, 0x12, 0x11, 0x12, 0x7D}, // �
	[131 - 32] ={0x00, 0x39, 0x44, 0x44, 0x44, 0x39}, // �
	[132 - 32] ={0x00, 0x3D, 0x42, 0x42, 0x42, 0x3D}, // �
	[133 - 32] ={0x00, 0x02, 0x05, 0x02, 0x00, 0x00}, // �
	[134 - 32] ={0x00, 0x7E, 0x01, 0x49, 0x55, 0x73}, // �
	[135 - 32] ={0x00, 0x7C, 0x10, 0x10, 0x08, 0x1C}, // �
	[136 - 32] ={0x00, 0x30, 0x48, 0x20, 0x48, 0x30}, // ?
	[137 - 32] ={0x00, 0x5C, 0x62, 0x02, 0x62, 0x5C} // ?
	// Add other characters as needed
};

static uint8_t ssd1306_buffer[1024];

void ssd1306_init(void) {
	i2c_init();
	_delay_ms(100); // Delay for power-on reset

	ssd1306_command(SSD1306_DISPLAYOFF);
	ssd1306_command(SSD1306_SETDISPLAYCLOCKDIV);
	ssd1306_command(0x80); // Default setting
	ssd1306_command(SSD1306_SETMULTIPLEX);
	ssd1306_command(0x3F); // 1/64 duty
	ssd1306_command(SSD1306_SETDISPLAYOFFSET);
	ssd1306_command(0x00); // No offset
	ssd1306_command(SSD1306_SETSTARTLINE | 0x00); // Line 0
	ssd1306_command(SSD1306_CHARGEPUMP);
	ssd1306_command(0x14); // Enable charge pump
	ssd1306_command(SSD1306_MEMORYMODE);
	ssd1306_command(0x00); // Horizontal addressing mode
	ssd1306_command(SSD1306_SEGREMAP | 0x01);
	ssd1306_command(SSD1306_COMSCANDEC);
	ssd1306_command(SSD1306_SETCOMPINS);
	ssd1306_command(0x12);
	ssd1306_command(SSD1306_SETCONTRAST);
	ssd1306_command(0xCF);
	ssd1306_command(SSD1306_SETPRECHARGE);
	ssd1306_command(0xF1);
	ssd1306_command(SSD1306_SETVCOMDETECT);
	ssd1306_command(0x40);
	ssd1306_command(SSD1306_DISPLAYALLON_RESUME);
	ssd1306_command(SSD1306_NORMALDISPLAY);
	ssd1306_command(SSD1306_DISPLAYON);

  memset(ssd1306_buffer, 0x00, 1024);
}

void ssd1306_command(uint8_t command) {
	i2c_start(SSD1306_I2C_ADDRESS);
	i2c_byte(0x00); // Co = 0, D/C# = 0
	i2c_byte(command);
	i2c_stop();
}

void ssd1306_data(uint8_t data) {
	i2c_start(SSD1306_I2C_ADDRESS);
	i2c_byte(0x40); // Co = 0, D/C# = 1
	i2c_byte(data);
	i2c_stop();
}

void ssd1306_update_screen(void) {
    for (uint8_t i = 0; i < 8; i++) {
        ssd1306_command(0xB0 + i); // set page address
        ssd1306_command(0x00); // set lower column address
        ssd1306_command(0x10); // set higher column address

        i2c_start(SSD1306_I2C_ADDRESS << 1);
        i2c_write(0x40); // Co = 0, D/C# = 1

        for (uint8_t j = 0; j < 128; j++) {
            i2c_write(ssd1306_buffer[i * 128 + j]);
        }

        i2c_stop();
    }
}

void ssd1306_display_bytes(uint8_t x, uint8_t y, uint8_t* bytes) {
    ssd1306_command(0xB0 + y - 1); // Set page address
    ssd1306_command(0x00 + (x & 0x0F)); // Set lower column address
    ssd1306_command(0x10 + ((x >> 4) & 0x0F)); // Set higher column address

    i2c_start(SSD1306_I2C_ADDRESS);
    i2c_byte(0x40); // Co = 0, D/C# = 1
    for (uint8_t i = 0; i < 6; i++) {
        i2c_byte(bytes[i]);
    }
    i2c_stop();
}

void ssd1306_display_char(uint8_t x, uint8_t y, char c) {
	if (c < 32 || c > 137) return; // Ensure character is in the valid range
	ssd1306_display_bytes(x, y, font[c - 32]);
}

void ssd1306_display_string(uint8_t x, uint8_t y, char *str) {
	while (*str != '\0') {
		ssd1306_display_char(x, y, *str);
		str++;
		x += 7; // Move to the next character position
		if (x > 124)
		{
			y++;
			x = 0;
		}
	}
}
void ssd1306_clear_display(void) {
    for (uint16_t i = 0; i < 1024; i++) {
        ssd1306_data(0x00);
    }
}

void ssd1306_clear_line(uint8_t line) {
    ssd1306_display_string(0, line, "                       "); // Giả sử mỗi dòng có 16 ký tự trống
}

void ssd1306_display_begin(void){
  ssd1306_clear_display();
	ssd1306_display_string(0, 1, "-----WELCOME-----");
  ssd1306_display_string(0, 2, "My Project-Hop");
  ssd1306_display_string(0, 8, "-----THE END-----");
}
/*
void ssd1306_fill_rect(uint8_t x, uint8_t y, uint8_t width, uint8_t height, uint8_t color) {
    if (x >= SSD1306_WIDTH || y >= SSD1306_HEIGHT) return;
    if ((x + width) > SSD1306_WIDTH)  width = SSD1306_WIDTH - x;
    if ((y + height) > SSD1306_HEIGHT) height = SSD1306_HEIGHT - y;
    
    uint8_t startPage = y / 8;
    uint8_t endPage = (y + height - 1) / 8;

    for (uint8_t page = startPage; page <= endPage; page++) {
        ssd1306_command(SSD1306_SET_PAGE_ADDR);
        ssd1306_command(page);
        ssd1306_command(SSD1306_SET_PAGE_ADDR + 1);
        ssd1306_command(x);
        ssd1306_command(x + width - 1);

        for (uint8_t col = x; col < x + width; col++) {
            if (color == WHITE) {
                ssd1306_data(0xFF); // Vẽ hình chữ nhật đầy màu trắng
            } else {
                ssd1306_data(0x00); // Vẽ hình chữ nhật đầy màu đen
            }
        }
    }
}
/*
void ssd1306_displayInt(int x, int y, int value) {
    char buffer[12]; // Buffer to hold the string representation of the integer
    itoa(value, buffer, 10); // Convert integer to string

    int length = strlen(buffer);
    for (int i = 0; i < length; i++) {
        ssd1306_drawChar(x + (i * 6), y, buffer[i]); // Draw each character
    }
}*/